{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-secondary"><i class="fas fa-building me-2"></i> QUẢN LÝ PHÒNG & CƯ DÂN</h3>
    <button class="btn btn-success fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#addRoomModal">
        <i class="fas fa-plus me-2"></i> Thêm Phòng
    </button>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card card-custom border-0 shadow-sm" style="min-height: 500px;">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold text-primary m-0">1. Danh Sách Phòng</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Mã Phòng</th>
                            <th>Tòa - Khu</th>
                            <th class="text-center">Sức Chứa</th>
                            <th class="text-center">Đang Ở</th>
                            <th class="text-center">Trạng Thái</th>
                            <th class="text-end pe-4">Sửa/Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rooms %}
                        <tr style="cursor: pointer;" onclick="loadRoomStudents('{{ r[0] }}')">
                            <td class="ps-4 fw-bold text-primary">{{ r[0] }}</td>
                            <td>{{ r[1] }} - {{ r[2] }}</td>
                            <td class="text-center">{{ r[3] }}</td>
                            <td class="text-center fw-bold">{{ r[4] }}</td>
                            <td class="text-center">
                                {% if r[5] == 'Đầy' or r[4] >= r[3] %}
                                    <span class="badge bg-danger">Đầy</span>
                                {% else %}
                                    <span class="badge bg-success">Trống</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <form method="POST" action="{{ url_for('admin_phong') }}" class="d-inline" onsubmit="return confirm('Bạn chắc chắn muốn xóa phòng {{ r[0] }}?');">
                                    <input type="hidden" name="action" value="delete_room">
                                    <input type="hidden" name="maphong" value="{{ r[0] }}">
                                    <button class="btn btn-outline-danger btn-sm p-1" title="Xóa phòng">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center py-4">Chưa có dữ liệu phòng.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card card-custom border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="fw-bold text-success m-0" id="room-title">Phòng: ---</h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="table-responsive flex-grow-1">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr class="text-muted small">
                                <th>Mã SV</th>
                                <th>Họ Tên</th>
                                <th class="text-end">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body">
                            <tr>
                                <td colspan="3" class="text-center text-muted py-5">
                                    <i class="fas fa-arrow-left me-2"></i>Chọn một phòng bên trái để xem
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 pt-3 border-top">
                    <form method="POST" action="{{ url_for('admin_phong') }}" class="input-group">
                        <input type="hidden" name="action" value="add_student_to_room">
                        <input type="hidden" name="phong_id" id="input-phong-id">
                        
                        <input type="text" name="masv" class="form-control" placeholder="Nhập Mã SV cần thêm..." required>
                        <button class="btn btn-success fw-bold" type="submit" id="btn-add-sv" disabled>
                            <i class="fas fa-plus"></i> Thêm
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Thêm Phòng Mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('admin_phong') }}">
                    <input type="hidden" name="action" value="add_room">
                    <div class="mb-3">
                        <label class="fw-bold">Mã Phòng:</label>
                        <input type="text" name="maphong" class="form-control" placeholder="VD: P101..." required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Tòa:</label>
                            <select name="toa" class="form-select">
                                <option value="Tòa A">Tòa A</option>
                                <option value="Tòa B">Tòa B</option>
                                <option value="Tòa C">Tòa C</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Khu:</label>
                            <select name="khu" class="form-select">
                                <option value="Khu 1">Khu 1</option>
                                <option value="Khu 2">Khu 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Sức chứa:</label>
                        <input type="number" name="succhua" class="form-control" value="4" min="1" required>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary fw-bold">Lưu lại</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function loadRoomStudents(roomId) {
        // 1. Cập nhật tiêu đề bên phải
        document.getElementById('room-title').innerText = 'Phòng: ' + roomId;
        document.getElementById('room-title').className = "fw-bold text-primary m-0";
        
        // 2. Cập nhật input hidden để form biết thêm vào phòng nào
        document.getElementById('input-phong-id').value = roomId;
        document.getElementById('btn-add-sv').disabled = false;

        // 3. Gọi API lấy danh sách SV (Hàm này vẫn còn trong app.py nên dùng ok)
        const tbody = document.getElementById('student-list-body');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>';

        fetch(`/api/room/${roomId}/students`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = ''; // Xóa icon loading

                if (data.students && data.students.length > 0) {
                    data.students.forEach(sv => {
                        const row = `
                            <tr>
                                <td class="fw-bold">${sv.masv}</td>
                                <td>${sv.hoten}</td>
                                <td class="text-end">
                                    <form method="POST" action="{{ url_for('admin_phong') }}" onsubmit="return confirm('Đưa ${sv.hoten} ra khỏi phòng?');">
                                        <input type="hidden" name="action" value="remove_student">
                                        <input type="hidden" name="masv" value="${sv.masv}">
                                        <button class="btn btn-sm btn-light text-danger border-0 p-1" title="Xóa">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted fst-italic py-3">Phòng trống</td></tr>';
                }
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
            });
    }
</script>

{% endblock %}